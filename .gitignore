import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="Dashboard de Veh√≠culos", layout="wide")

st.title("üöó Dashboard de An√°lisis de Veh√≠culos")
st.markdown("Explora el conjunto de datos de anuncios de venta de coches.")

@st.cache_data
def load_data():
    df = pd.read_csv('vehicles_us.csv')
    df = df[(df['price'] > 0) & (df['odometer'] > 0)]
    return df

df = load_data()

st.sidebar.header("üéõÔ∏è Controles y Filtros")

show_data = st.sidebar.checkbox('Mostrar datos', value=True)
if show_data:
    st.subheader("Vista previa de los datos")
    st.dataframe(df.head(), use_container_width=True)
    st.caption(f"Datos cargados: {df.shape[0]} filas √ó {df.shape[1]} columnas")

st.sidebar.subheader("Configuraci√≥n de Gr√°ficos")
chart_type = st.sidebar.radio(
    "Tipo de gr√°fico",
    ["Histograma", "Dispersi√≥n"]
)

numeric_cols = df.select_dtypes(include=['int64', 'float64']).columns.tolist()

if chart_type == "Histograma":
    x_axis = st.sidebar.selectbox('Variable para histograma', numeric_cols, 
                                  index=numeric_cols.index('odometer') if 'odometer' in numeric_cols else 0)
else:
    col1, col2 = st.sidebar.columns(2)
    with col1:
        x_axis = st.selectbox('Eje X', numeric_cols, 
                             index=numeric_cols.index('odometer') if 'odometer' in numeric_cols else 0)
    with col2:
        y_axis = st.selectbox('Eje Y', numeric_cols, 
                             index=numeric_cols.index('price') if 'price' in numeric_cols else 0)

models = df['model'].dropna().unique()
selected_model = st.sidebar.multiselect('Filtrar por modelo', 
                                       options=sorted(models), 
                                       default=[])
df_filtered = df[df['model'].isin(selected_model)] if selected_model else df

st.header(f"üìä {chart_type}")

col1, col2 = st.columns(2)
with col1:
    hist_button = st.button('üìà Generar Histograma', use_container_width=True)
with col2:
    scatter_button = st.button('üîò Generar Dispersi√≥n', use_container_width=True)

if hist_button:
    st.success('Generando histograma...')
    fig = px.histogram(df_filtered, x='odometer', 
                      title='Distribuci√≥n del Od√≥metro',
                      labels={'odometer': 'Od√≥metro (millas)'},
                      color_discrete_sequence=['#3498db'])
    st.plotly_chart(fig, use_container_width=True)

if scatter_button:
    st.success('Generando gr√°fico de dispersi√≥n...')
    fig = px.scatter(df_filtered, x='odometer', y='price',
                    title='Relaci√≥n: Od√≥metro vs Precio',
                    labels={'odometer': 'Od√≥metro (millas)', 'price': 'Precio (USD)'},
                    color_discrete_sequence=['#e74c3c'])
    st.plotly_chart(fig, use_container_width=True)

st.divider()

st.subheader("üéØ Visualizaci√≥n Avanzada")
build_hist = st.checkbox('Mostrar histograma personalizado')
build_scatter = st.checkbox('Mostrar dispersi√≥n personalizada')

if build_hist:
    fig = px.histogram(df_filtered, x=x_axis, 
                      title=f'Distribuci√≥n de {x_axis}',
                      color_discrete_sequence=['#2ecc71'])
    st.plotly_chart(fig, use_container_width=True)

if build_scatter and chart_type == "Dispersi√≥n":
    fig = px.scatter(df_filtered, x=x_axis, y=y_axis,
                    title=f'{x_axis} vs {y_axis}',
                    color_discrete_sequence=['#f39c12'])
    st.plotly_chart(fig, use_container_width=True)

st.sidebar.divider()
st.sidebar.info("üí° **Consejo**: Usa los filtros para explorar datos espec√≠ficos por modelo.")
